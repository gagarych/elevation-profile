!function(){ElevationProfile=function(a,b,c){function d(a){return new google.maps.LatLng(a.lat,a.lng)}function e(a,c){return new google.maps.Polyline({path:b.map(function(a){return d(a.location)}),strokeColor:c,strokeOpacity:1,strokeWeight:a,map:x})}function f(){E.style("display",null),y.setMap(x)}function g(){E.style("display","none"),y.setMap(null)}function h(a,b){return google.maps.geometry.spherical.computeDistanceBetween(d(a.location),b)}function i(a){var c=d3.bisector(function(a){return a.distance}).right;return b[c(b,t.invert(a))]}function j(a){return 0>a||a>c.width?0:u(i(a).elevation)}function k(a){if(a){E.attr("transform","translate("+t(a.distance)+",0)"),E.select("text").text(d3.round(a.elevation,0)+"m"),E.select("circle").attr("transform","translate(0, "+u(a.elevation)+")");var b=d(a.location);y.setPosition(b)}}function l(){k(i(d3.mouse(this)[0]))}function m(){k(i(d3.touches(this)[0][0]))}function n(a){var b=H.append("text").text(a),c=b.node().getBBox();return b.remove(),c}function o(a,b,c){function d(a,c){return{x:a,y:c,rect:b,sx:e,sy:f}}var e=t(a.distance),f=j(e);return[d(e-b.width-c,f-b.height-c),d(e+c,f-b.height-c),d(e+c,f+c-b.height-5),d(e-b.width-c,f+c-b.height-5)]}function p(a,b){return!(b.x>a.x+a.rect.width||b.x+b.rect.width<a.x||b.y>a.y+a.rect.height||b.y+b.rect.height<a.y)}function q(a,b){if(a.x<0||a.x+b.width>c.width)return!1;for(var d=0;d<I.length;d++)if(p(I[d],a))return!1;for(var d=-10;d<b.width+10;d++){var e=j(a.x+d);if(a.y-5<=e&&e<=a.y+b.height+5)return!1}return!0}function r(a,b){for(var c=n(b),d=25,e=o(a,c,d),f=0;f<e.length;f++)if(q(e[f],c))return e[f];return null}function s(a,b,c){G.append("circle").attr("cx",a.sx).attr("cy",a.sy).attr("r",1),G.append("text").attr("x",a.x).attr("y",a.y+a.rect.height).text(c.name),G.append("line").attr("x1",a.x).attr("x2",a.x+a.rect.width).attr("y1",a.y+a.rect.height+5).attr("y2",a.y+a.rect.height+5).style("text-anchor","start"),G.append("line").attr("x1",a.sx).attr("y1",a.sy).attr("x2",a.x<a.sx?a.x+a.rect.width:a.x).attr("y2",a.y+a.rect.height+5)}c=c||{},c.height=c.height||400,c.padding=c.padding||40,c.width=c.width||a.node().offsetWidth,c.baseElevation=c.baseElevation||1500,c.extraElevation=c.extraElevation||500,c.gMapZoomLevel=c.gMapZoomLevel||11,b=b.sort(function(a,b){return a.distance-b.distance});var t=d3.scale.linear().domain([0,d3.max(b,function(a){return a.distance})]).range([c.padding,c.width]),u=d3.scale.linear().domain([c.baseElevation,d3.max(b,function(a){return a.elevation})+c.extraElevation]).range([c.height-c.padding,c.padding]),v=d(b[b.length/2].location),w=a.append("div").attr("class","gmap").style("width",c.width+"px").style("height",c.height+"px"),x=new google.maps.Map(w.node(),{zoom:c.gMapZoomLevel,center:v,mapTypeId:"terrain"});e(6,"#fff"),e(3,"#600");var y=new google.maps.Marker({position:v,title:"walk"}),z=a.append("svg:svg").attr("width",c.width).attr("height",c.height),A=z.append("svg:g"),B=d3.svg.axis().scale(t).orient("bottom").ticks(10),C=d3.svg.axis().scale(u).orient("left").ticks(10);z.append("g").attr("class","axis").attr("transform","translate(0,"+(c.height-c.padding)+")").call(B).append("text").attr("x",c.width-7).attr("y",-7).style("text-anchor","end").text("km"),z.append("g").attr("class","axis").attr("transform","translate("+c.padding+",0)").call(C).append("text").attr("y",c.padding+7).attr("x",15).style("text-anchor","end").text("m");{var D=d3.svg.area().x(function(a){return t(a.distance)}).y0(c.height-c.padding).y1(function(a){return u(a.elevation)});A.append("svg:path").attr("d",D(b))}A.append("path").datum(b).attr("class","area").attr("d",D);var E=A.append("g").attr("class","focus").style("display","none");E.append("line").attr("y1",c.padding).attr("y2",c.height-c.padding),E.append("line").attr("y1",c.padding).attr("y2",c.padding).attr("x2","50px"),E.append("circle").attr("r",3),E.append("text").attr("x",3).attr("dy",c.padding-3),google.maps.event.addListener(x,"mouseover",f),google.maps.event.addListener(x,"mouseout",g),google.maps.event.addListener(x,"mousemove",function(a){var c=b[0],d=null;b.forEach(function(b){var e=h(b,a.latLng);(null==d||d>e)&&(d=e,c=b)}),k(c)});var F=b.filter(function(a){return!!a.places}),G=A.append("g").attr("class","notes"),H=z.append("g").style("display","none"),I=[];F.forEach(function(a){a.places.forEach(function(b){if(b.name){var c=r(a,b.name);c&&(I.push(c),s(c,a,b))}})}),A.append("rect").attr("class","overlay").attr("width",c.width).attr("height",c.height-c.padding).attr("dx",c.padding).attr("dy",c.padding).on("mouseover",f).on("mouseout",g).on("mousemove",l).on("touchstart",f).on("touchmove",m)}}(),d3.selectAll("div[data-item='elevation-profile']").forEach(function(a){a.forEach(function(a){var b=d3.select(a);d3.json(b.attr("data-src"),function(a,c){if(a)return console.warn(a);var d={},e=b.attr("data-opts");e&&(d=JSON.parse(e)),new ElevationProfile(b,c,d)})})});